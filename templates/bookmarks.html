<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="none">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¸€è¦§</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chick-theme.css') }}">
    <style>
        .bookmark-item {
            text-align: center;
            font-family: 'Arial', sans-serif;
            background: var(--chick-white);
            border: 3px solid var(--chick-border);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 32px var(--chick-shadow);
            transition: transform 0.3s ease;
        }
        
        .bookmark-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px var(--chick-shadow);
        }
        
        .bookmark-item h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--chick-text);
            font-size: 1.2rem;
            text-align: center;
            font-weight: 600;
        }
        
        .chart-container {
            width: 100%;
            aspect-ratio: 1.5 / 1;
            max-height: 320px;
            margin: 0 auto;
            overflow: hidden;
            position: relative;
            background: #fffef7;
            border-radius: 15px;
            border: 2px solid var(--chick-yellow);
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 15px;
            padding-top: 15px;
            border-top: 3px solid var(--chick-yellow);
        }
        
        .controls > div {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .remove-bookmark-btn {
            background: linear-gradient(45deg, #ffcdd2, #f44336);
            color: white;
            border: 3px solid #f44336;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .remove-bookmark-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
        }
        
        .year-selector {
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 15px;
            border: 3px solid var(--chick-border);
            background: var(--chick-white);
            color: var(--chick-text);
            font-family: inherit;
        }
        
        .loading-text, .error-text {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            text-align: center;
            padding: 20px;
            color: var(--chick-text);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .error-text {
            color: #c0392b;
        }
        
        .empty-bookmarks {
            text-align: center;
            padding: 40px 20px;
            color: var(--chick-text-light);
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¸€è¦§</h1>
        
        
        <div class="nav-links">
            <a href="{{ url_for('report') }}">ğŸ”™ æ¤œç´¢ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
            <a href="{{ url_for('summary_page') }}">ğŸ“Š æˆç¸¾åˆ†å¸ƒä¸€è¦§</a>
        </div>
        <div class="description">
        <p>
            è¡¨ç¤ºç§‘ç›®ã®å¹´åº¦ã‚’å¤‰æ›´ã—ãŸã‚ã¨ã€<strong>ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ä¸­</strong>ã¨ã„ã†è¡¨ç¤ºãŒå‡ºãŸã‚‰ã€ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
        </p>
        </div>
        <div id="bookmarks-content">
            <div class="loading-text">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script>
        const BOOKMARKS_KEY = 'subjectBookmarks';
        const availableYears = ['2022', '2023', '2024', 'average'];
        
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾© ---
        let activeChartObjects = {}; // { elementId: { chart: GoogleChartObject, subjectData: Object, dataTable: GoogleDataTable } }
        let googleChartsLoaded = false;
        let initialChartsRendered = false;
        let resizeDebounceTimeout;

        // --- Google Chartsãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ ---
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(() => {
            googleChartsLoaded = true;
            if (document.readyState === "complete" || document.readyState === "interactive") {
                loadBookmarkedSubjectsAndDraw();
            } else {
                // DOMContentLoadedãŒã¾ã ãªã‚‰å¾…ã¤ (é€šå¸¸ã¯charts.loadã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¾Œ)
            }
        });

        // --- ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨DOMæ“ä½œé–¢é€£é–¢æ•° (å¤‰æ›´å°‘ãªã‚) ---
        function getBookmarks() { /* å¤‰æ›´ãªã— */
            const bookmarks = localStorage.getItem(BOOKMARKS_KEY);
            return bookmarks ? JSON.parse(bookmarks) : [];
        }
        function saveBookmarks(bookmarks) { /* å¤‰æ›´ãªã— */
            localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
        }
        async function fetchSubjectDataForChart(subjectId, year = 'average') { /* å¤‰æ›´ãªã— */
            try {
                const response = await fetch(`/api/subject_grade_data/${subjectId}?year=${year}`);
                if (!response.ok) {
                    let errorData = { error: `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (HTTP ${response.status})` }; 
                    try { errorData = await response.json(); } catch (e) {
                        const errorText = await response.text(); errorData.error = errorText || errorData.error; 
                        console.warn(`API Error (not JSON): ${response.status}, ${errorText.substring(0,100)}`);
                    }
                    const message = errorData.error || `ä¸æ˜ãªã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (HTTP ${response.status})`;
                    return { error: `ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ${message} (ç§‘ç›®ID: ${subjectId}, å¹´åº¦: ${year})` };
                }
                return await response.json();
            } catch (networkError) { 
                return { error: `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼ (ç§‘ç›®ID: ${subjectId}, å¹´åº¦: ${year})` };
            }
        }
        
        // --- ã‚°ãƒ©ãƒ•æç”»é–¢æ•° (å‹•çš„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†) ---
        function drawPieChart(elementId, subjectData) {
            const chartElement = document.getElementById(elementId);
            if (!chartElement) { console.error(`drawPieChart: Element ${elementId} not found.`); return; }

            if (!subjectData || subjectData.error) {
                chartElement.innerHTML = `<p class="error-text">ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:<br>${subjectData?.error || 'è©³ç´°ä¸æ˜'}</p>`;
                return;
            }
            if (!subjectData.counts || subjectData.counts.length !== 5) {
                 chartElement.innerHTML = `<p class="error-text">æˆç¸¾ãƒ‡ãƒ¼ã‚¿å½¢å¼ä¸å‚™</p>`; return;
            }

            const dataTable = google.visualization.arrayToDataTable([
                ['è©•ä¾¡', 'äººæ•°'],
                ['A+', subjectData.counts[0]], ['A', subjectData.counts[1]],
                ['B', subjectData.counts[2]], ['C', subjectData.counts[3]],
                ['D', subjectData.counts[4]]
            ]);
            const containerWidth = chartElement.offsetWidth; // ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒŠå¹…ã‚’å–å¾—
            let dynamicOptions = {
                title: `${subjectData.subject_name} (${subjectData.year})`,
                pieHole: 0.1, width: '100%', height: '100%', fontName: 'Arial',
                colors: [ // â† ã“ã“ã«colorsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç§»å‹•ãƒ»è¿½åŠ ã—ã¾ã™
                    '#FF0000', // çœŸã£èµ¤
                    '#FFA500', // ã‚ªãƒ¬ãƒ³ã‚¸
                    '#FFD700', // é»„å¼·ã‚ã®é»„ç·‘æ¿ƒã„è‰²
                    '#008000', // ç·‘
                    '#0000FF'  // é’
                ],
                legend: { position: 'bottom', alignment: 'center', textStyle: { fontSize: 10, color: '#444' } },
                titleTextStyle: { fontSize: 12, bold: false, color: '#333' },
                tooltip: { textStyle: { fontSize: 11 } },
                // chartAreaã¯æç”»é ˜åŸŸã€‚ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã«å¿œã˜ã¦èª¿æ•´ã™ã‚‹
                chartArea: { left: '8%', top: '12%', width: '84%', height: '65%' } // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            };

            // ã‚³ãƒ³ãƒ†ãƒŠå¹…ã«å¿œã˜ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å¾®èª¿æ•´
            if (containerWidth < 280) { // éå¸¸ã«ç‹­ã„å ´åˆ
                dynamicOptions.titleTextStyle.fontSize = 9;
                dynamicOptions.legend.position = 'none'; // å‡¡ä¾‹ã‚’éè¡¨ç¤º
                dynamicOptions.chartArea = { left: '5%', top: '10%', width: '90%', height: '80%' }; // æç”»é ˜åŸŸã‚’æœ€å¤§åŒ–
            } else if (containerWidth < 400) { // ã‚„ã‚„ç‹­ã„å ´åˆ
                dynamicOptions.titleTextStyle.fontSize = 10;
                dynamicOptions.legend.textStyle.fontSize = 9;
                dynamicOptions.chartArea = { left: '6%', top: '12%', width: '88%', height: '68%' };
            }
            // ãã‚Œä»¥ä¸Šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®chartAreaã‚’ä½¿ç”¨

            let chartObject = activeChartObjects[elementId]?.chart;
            if (!chartObject) {
                chartObject = new google.visualization.PieChart(chartElement);
            }
            
            activeChartObjects[elementId] = { chart: chartObject, subjectData: subjectData, dataTable: dataTable };
            chartObject.draw(dataTable, dynamicOptions);
        }

        // --- DOMè¦ç´ ç”Ÿæˆã¨åˆæœŸæç”»ãƒ•ãƒ­ãƒ¼ ---
        function removeBookmark(subjectId) {
            let bookmarks = getBookmarks();
            const originalLength = bookmarks.length;
            bookmarks = bookmarks.filter(bm => bm.id !== String(subjectId));
            
            if (bookmarks.length < originalLength) {
                saveBookmarks(bookmarks);
                console.log(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å‰Šé™¤: ${subjectId}`);
                return true; // å‰Šé™¤æˆåŠŸ
            } else {
                console.warn(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å‰Šé™¤å¤±æ•—: ${subjectId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                return false; // å‰Šé™¤å¤±æ•—
            }
        }

        function createBookmarkDOM(bookmark, index) {
            const itemDiv = document.createElement('div'); itemDiv.className = 'bookmark-item';
            const title = document.createElement('h3'); title.textContent = `ğŸ“– ${bookmark.name}`;
            const subtitle = document.createElement('div');
            subtitle.style.textAlign = 'center';
            subtitle.style.fontSize = '0.9rem';
            subtitle.style.color = 'var(--chick-text-light)';
            subtitle.style.marginBottom = '15px';
            subtitle.textContent = `ğŸ”¢ ç§‘ç›®ç•ªå·: ${bookmark.id}`;
            itemDiv.appendChild(title);
            itemDiv.appendChild(subtitle);
            
            const chartDivId = `chart_div_${bookmark.id.replace(/[^a-zA-Z0-9_]/g, "")}_${index}`;
            const chartDiv = document.createElement('div'); chartDiv.id = chartDivId; chartDiv.className = 'chart-container';
            chartDiv.innerHTML = '<p class="loading-text">ğŸ£ ã‚°ãƒ©ãƒ•ã‚’æº–å‚™ä¸­...</p>'; itemDiv.appendChild(chartDiv);
            
            const controlsDiv = document.createElement('div'); controlsDiv.className = 'controls';
            const yearToDisplay = activeChartObjects[chartDivId]?.subjectData?.year || bookmark.currentYear || 'average';
            const yearSelector = createYearSelectorElement(bookmark.id, yearToDisplay, chartDivId);
            const yearSelectorContainer = document.createElement('div');
            yearSelectorContainer.style.display = 'flex';
            yearSelectorContainer.style.flexWrap = 'nowrap'; // æ”¹è¡Œã•ã›ãªã„
            yearSelectorContainer.style.alignItems = 'center';
            yearSelectorContainer.style.gap = '8px'; // ãƒ©ãƒ™ãƒ«ã¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®é–“éš”

            const yearLabel = document.createElement('span');
            yearLabel.textContent = 'ğŸ“… è¡¨ç¤ºå¹´åº¦:';
            yearLabel.style.whiteSpace = 'nowrap'; // æ”¹è¡Œé˜²æ­¢
            yearSelectorContainer.appendChild(yearLabel);

            // yearSelectorï¼ˆ<select>ï¼‰ã«å¹…åˆ¶é™ã‚’è¿½åŠ 
            yearSelector.style.flexShrink = '0'; // ç¸®ã¾ãªã„ã‚ˆã†ã«
            yearSelector.style.maxWidth = '200px'; // é©åˆ‡ãªæœ€å¤§å¹…
            yearSelectorContainer.appendChild(yearSelector);

            controlsDiv.appendChild(yearSelectorContainer);

            const removeBtn = document.createElement('button'); 
            removeBtn.className = 'remove-bookmark-btn'; 
            removeBtn.textContent = 'ğŸ’” ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯è§£é™¤';
            removeBtn.onclick = () => { 
                // å‰Šé™¤ç¢ºèªã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                if (confirm(`ã€Œ${bookmark.name}ã€ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    const deleteSuccess = removeBookmark(bookmark.id);
                    if (deleteSuccess) {
                        // å‰Šé™¤æˆåŠŸæ™‚ã®å‡¦ç†
                        console.log(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å‰Šé™¤å®Œäº†: ${bookmark.name}`);
                        
                        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                        delete activeChartObjects[chartDivId];
                        
                        // å³åº§ã«DOMè¦ç´ ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦å‰Šé™¤
                        itemDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        itemDiv.style.opacity = '0';
                        itemDiv.style.transform = 'translateY(-20px)';
                        
                        setTimeout(() => {
                            // å®Œå…¨ã«å†èª­ã¿è¾¼ã¿ã—ã¦æœ€æ–°çŠ¶æ…‹ã‚’è¡¨ç¤º
                            loadBookmarkedSubjectsAndDraw();
                        }, 300); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå®Œäº†å¾Œã«å†èª­ã¿è¾¼ã¿
                    } else {
                        alert('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                    }
                }
            };
            controlsDiv.appendChild(removeBtn);
            itemDiv.appendChild(controlsDiv);
            return { itemDiv, chartDivId };
        }
        
        async function loadBookmarkedSubjectsAndDraw() {
            if (!googleChartsLoaded) { console.log("Google Chartsãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­è¾¼"); return; }

            const bookmarks = getBookmarks();
            const contentDiv = document.getElementById('bookmarks-content');
            
            contentDiv.innerHTML = ''; // æ—¢å­˜ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            activeChartObjects = {};   // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ã‚¯ãƒªã‚¢

            if (bookmarks.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-bookmarks">
                        <div class="chick-decoration">ğŸ£ğŸ’”ğŸ¥</div>
                        <h3>ã¾ã ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ã‚‹ç§‘ç›®ã¯ã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>ğŸ” æ¤œç´¢ãƒšãƒ¼ã‚¸ã§ç§‘ç›®ã‚’æ¢ã—ã¦ã€â­ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                        <div class="nav-links" style="margin-top: 20px;">
                            <a href="${window.location.origin}/report.html">ğŸ” æ¤œç´¢ãƒšãƒ¼ã‚¸ã¸</a>
                        </div>
                    </div>
                `;
                initialChartsRendered = false; // ãƒãƒ£ãƒ¼ãƒˆãŒãªã„ã®ã§ãƒªã‚»ãƒƒãƒˆ
                return;
            }

            // ã¾ãšDOMè¦ç´ ã‚’å…¨ã¦ç”Ÿæˆã—ã¦é…ç½®
            bookmarks.forEach((bookmark, index) => {
                const { itemDiv } = createBookmarkDOM(bookmark, index);
                contentDiv.appendChild(itemDiv);
            });

            // æ¬¡ã«å„ãƒãƒ£ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æç”» (éåŒæœŸå‡¦ç†ã‚’è€ƒæ…®)
            // Promise.allã§å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æç”»å‡¦ç†ã‚’ä¸¦è¡Œã—ã¦è¡Œã†
            const drawPromises = bookmarks.map(async (bookmark, index) => {
                const chartDivId = `chart_div_${bookmark.id.replace(/[^a-zA-Z0-9_]/g, "")}_${index}`;
                const yearToFetch = bookmark.currentYear || 'average';
                const subjectData = await fetchSubjectDataForChart(bookmark.id, yearToFetch);
                
                // createBookmarkDOMã§è¨­å®šã—ãŸloading textã‚’ä¸Šæ›¸ãã™ã‚‹ãŸã‚ã«ã€ã“ã“ã§å†åº¦ chartElement ã‚’å–å¾—
                const chartElement = document.getElementById(chartDivId);
                if (chartElement) { // chartElementãŒDOMã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
                     drawPieChart(chartDivId, subjectData);
                } else {
                    console.error(`loadBookmarkedSubjectsAndDraw: Element ${chartDivId} not found in DOM for drawing.`);
                }
            });

            try {
                await Promise.all(drawPromises);
                initialChartsRendered = true; // å…¨ã¦ã®åˆæœŸæç”»ãŒå®Œäº†
                console.log("å…¨ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚°ãƒ©ãƒ•ã®åˆæœŸæç”»å®Œäº†");
            } catch (error) {
                console.error("ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚°ãƒ©ãƒ•æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
                contentDiv.innerHTML = '<p class="error-text">ä¸€éƒ¨ã‚°ãƒ©ãƒ•ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                initialChartsRendered = false;
            }
        }

        function createYearSelectorElement(subjectId, currentSelectedYear, chartDivId) {
            const selector = document.createElement('select');
            selector.className = 'year-selector';
            availableYears.forEach(y => {
                const option = document.createElement('option'); option.value = y; option.textContent = y;
                if (y === currentSelectedYear) option.selected = true;
                selector.appendChild(option);
            });
            selector.addEventListener('change', async function() {
                const newYear = this.value;
                const chartElement = document.getElementById(chartDivId);
                if (chartElement) chartElement.innerHTML = '<p class="loading-text">ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ä¸­...</p>';
                
                let bookmarks = getBookmarks();
                let bmToUpdate = bookmarks.find(b => b.id === subjectId);
                if (bmToUpdate) bmToUpdate.currentYear = newYear; // currentYearã‚’æ›´æ–°
                saveBookmarks(bookmarks); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜

                const updatedSubjectData = await fetchSubjectDataForChart(subjectId, newYear);
                drawPieChart(chartDivId, updatedSubjectData); // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§å†æç”»
            });
            return selector;
        }

        // --- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç† ---
        window.addEventListener('resize', () => {
            clearTimeout(resizeDebounceTimeout);
            resizeDebounceTimeout = setTimeout(() => {
                if (!googleChartsLoaded || !initialChartsRendered || Object.keys(activeChartObjects).length === 0) {
                    return; // æç”»å¯¾è±¡ãŒãªã„ã€ã¾ãŸã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰ä½•ã‚‚ã—ãªã„
                }
                console.log("ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ¤œçŸ¥ - ã‚°ãƒ©ãƒ•å†æç”»é–‹å§‹");
                Object.keys(activeChartObjects).forEach(elementId => {
                    const chartInfo = activeChartObjects[elementId];
                    if (chartInfo && chartInfo.chart && chartInfo.subjectData) {
                        // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹subjectDataã‚’ä½¿ç”¨ã—ã¦å†æç”» (ãƒ‡ãƒ¼ã‚¿å†å–å¾—ãªã—)
                        drawPieChart(elementId, chartInfo.subjectData);
                    }
                });
            }, 300); // 300ãƒŸãƒªç§’ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
        });

        // --- åˆæœŸèª­ã¿è¾¼ã¿ãƒˆãƒªã‚¬ãƒ¼ ---
        document.addEventListener('DOMContentLoaded', () => {
            if (googleChartsLoaded && !initialChartsRendered) {
                // DOMContentLoadedæ™‚ç‚¹ã§Chartsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã ãŒã€ã¾ã åˆæœŸæç”»ãŒèµ°ã£ã¦ã„ãªã„å ´åˆ
                loadBookmarkedSubjectsAndDraw();
            }
        });
    </script>
</body>
</html>